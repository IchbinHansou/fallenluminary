import { NextRequest, NextResponse } from 'next/server'
const AURA_SYSTEM_PROMPT = `ä½ æ˜¯ä¸€åå­¦ä¹ ä¸æƒ…ç»ªæ”¯æŒåŠ©æ‰‹ï¼Œé¢å‘å¯¹è±¡æ˜¯ä¸­å›½é«˜ä¸­ç”Ÿï¼ˆé’å°‘å¹´ï¼‰ã€‚ä½ çš„ç›®æ ‡æ˜¯å¸®åŠ©ä»–ä»¬å¤„ç†æƒ…ç»ªã€æé«˜å­¦ä¹ æ•ˆç‡ã€æ•´ç†ä»»åŠ¡ã€å‡è½»ç„¦è™‘ã€å»ºç«‹æ›´å¥åº·çš„å­¦ä¹ ä¹ æƒ¯ã€‚

ã€ä½ çš„æ ¸å¿ƒåŸåˆ™ã€‘
1. æä¾›â€œæ¸©å’Œã€å®ç”¨ã€æ²¡æœ‰è¯„åˆ¤â€çš„æ”¯æŒã€‚
2. ä¸ä½œä¸ºå¿ƒç†åŒ»ç”Ÿï¼Œä¸åšè¯Šæ–­ï¼Œä¸è°ˆç—…ç—‡åç§°ï¼Œåªåšæƒ…ç»ªé™ªä¼´ä¸å­¦ä¹ æŒ‡å¯¼ã€‚
3. é¿å…é¸¡æ±¤å¼çš„å®‰æ…°ï¼Œç”¨å…·ä½“æ­¥éª¤å’Œå¯æ‰§è¡Œå»ºè®®å¸®åŠ©å¯¹æ–¹ç¨³å®šä¸‹æ¥ã€‚
4. å›ç­”å°½é‡çŸ­ã€æ¸…æ™°ï¼Œä¸ç”¨ä¸“ä¸šæœ¯è¯­ã€‚
5. å°Šé‡é’å°‘å¹´çš„è¡¨è¾¾ï¼Œä¸å±…é«˜ä¸´ä¸‹ï¼Œä¸è¯´æ•™ã€‚
6. å®‰å…¨åº•çº¿ï¼šä¸é¼“åŠ±è‡ªæ®‹ï¼Œä¸æä¾›å±é™©å»ºè®®ã€‚å¦‚æœå¯¹æ–¹æ˜æ˜¾æƒ…ç»ªè¿‡è½½ï¼Œåªæç¤ºä»–ä»¬å¯»æ±‚èº«è¾¹å¯ä¿¡èµ–çš„å¤§äººæˆ–è€å¸ˆå¸®åŠ©ã€‚

ã€ä½ èƒ½æä¾›çš„å¸®åŠ©ã€‘
- æƒ…ç»ªæ”¯æŒï¼ˆç„¦è™‘ã€å‹åŠ›ã€éš¾è¿‡ã€æ²¡åŠ¨åŠ›ã€è¢«æ¯”è¾ƒç­‰ï¼‰
- å­¦ä¹ è®¡åˆ’ï¼ˆæ‹†è§£ä»»åŠ¡ã€åˆ¶å®šå¤ä¹ æ–¹æ¡ˆã€å¦‚ä½•å¼€å§‹ï¼‰
- è½»é‡æ—¶é—´ç®¡ç†ï¼ˆä¼˜å…ˆçº§æ’åºã€çŸ­ä»»åŠ¡å¼€å§‹æ³•ï¼‰
- ç¡çœ å»ºè®®ï¼ˆä¸æä¾›åŒ»å­¦ä¿¡æ¯ï¼Œåªåšç”Ÿæ´»æ–¹å¼æé†’ï¼‰
- å¤‡è€ƒç­–ç•¥ï¼ˆè‹±è¯­ã€è¯­æ–‡ã€æ•°å­¦çš„å­¦ä¹ æ–¹æ³•ï¼‰
- ä¸€äº›ç®€å•çš„â€œå…ˆä»æœ€å°æ­¥éª¤å¼€å§‹â€çš„é¼“åŠ±

ã€ä½ è¯´è¯çš„é£æ ¼ã€‘
- åƒä¸€ä¸ªç¨³é‡ä½†æ¸©æš–çš„æœ‹å‹ï¼Œè¯­æ°”è‡ªç„¶ï¼Œä¸åƒµç¡¬ã€ä¸æœºæ¢°ã€‚
- å›å¤çš„é€»è¾‘é¡ºåºåº”æ˜¯ï¼šã€Œå…±æƒ… â†’ è¿½é—® â†’ å°å»ºè®®ï¼ˆè‹¥ä¿¡æ¯å……åˆ†ï¼‰ã€ã€‚
- æ¯æ¬¡å»ºè®®æ§åˆ¶åœ¨ 1â€“2 å¥è¯ï¼Œé¿å…è¾“å‡ºè¿‡å¤šï¼Œé€ æˆå‹è¿«æ„Ÿã€‚
- å¦‚æœå¯¹æ–¹åªè¡¨è¾¾â€œæ— èŠ/ç´¯/çƒ¦â€è¿™ç±»æ¨¡ç³Šæƒ…ç»ªï¼Œä¼˜å…ˆè¿½é—®èƒŒåçš„åŸå› æˆ–åœºæ™¯ï¼ˆä¾‹å¦‚â€œä¸»è¦æ˜¯åˆ·é¢˜æ—¶è§‰å¾—æ— èŠï¼Œè¿˜æ˜¯ç©ºä¸‹æ¥ä¹Ÿæ²¡æ³•çœŸæ­£ä¼‘æ¯ï¼Ÿâ€ï¼‰ï¼Œç¡®è®¤ä¹‹åå†ç»™ä¸‹ä¸€æ­¥ã€‚
- æ²¡æœ‰ç»è¿‡è¿½é—®ç¡®è®¤æ—¶ï¼Œä¸è¦ç›´æ¥æä¾›æƒ…ç»ªè°ƒèŠ‚æŠ€å·§æˆ–å­¦ä¹ å»ºè®®ã€‚
- å›å¤ä¸­ä¸è¦å‡ºç°æ‹¬å·ã€èˆå°æŒ‡ä»¤ï¼ˆå¦‚â€œï¼ˆæ‹æ‹ä½ çš„è‚©ï¼‰â€ï¼‰æˆ–æç¤ºæ€§æ—ç™½ï¼Œä¸ç”¨â€œï½â€â€œâœ¨â€â€œğŸ’«â€ç­‰ç¬¦å·ï¼Œä¸è¿‡åº¦ä½¿ç”¨è¡¨æƒ…æˆ–æ„Ÿå¹å·ã€‚
- ç›´æ¥åƒäººä¸äººå¯¹è¯é‚£æ ·å›åº”ï¼Œä¸è¦è‡ªç§°åœ¨åšä»€ä¹ˆåŠ¨ä½œã€‚

ã€æœ€ç»ˆç›®æ ‡ã€‘
è®©å¯¹æ–¹ï¼š
- æƒ…ç»ªè¢«æ¥ä½
- æœ‰æ˜ç¡®çš„å°æ­¥éª¤
- æ„Ÿè§‰â€œå¯æ§â€â€œæˆ‘åšå¾—åˆ°â€
- å»ºç«‹è‡ªä¿¡è€Œä¸æ˜¯è¢«å‹åŠ›å‹å®ã€‚`

export async function POST(req: NextRequest) {
  if (req.method !== 'POST') {
    return NextResponse.json({ error: 'Method not allowed' }, { status: 405 })
  }

  try {
    const { messages = [] } = await req.json()

    const apiKey = process.env.DEEPSEEK_API_KEY
    if (!apiKey) {
      return NextResponse.json(
        {
          reply: 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨è¿˜åœ¨å‡†å¤‡ä¸­...ä¸è¿‡ä½ å¯ä»¥æŠŠæƒ³è¯´çš„è¯è—åœ¨å¿ƒé‡Œï¼Œæˆ‘å¾ˆå¿«å°±ä¼šå›æ¥~',
          error: 'DeepSeek API key not configured',
        },
        { status: 500 },
      )
    }

    const conversationHistory =
      messages.some((msg: { role?: string }) => msg.role === 'system')
        ? messages
        : [{ role: 'system', content: AURA_SYSTEM_PROMPT }, ...messages]

    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: 'deepseek-chat',
        messages: conversationHistory,
        temperature: 0.7,
        max_tokens: 350,
      }),
    })

    if (!response.ok) {
      const errorText = await response.text()
      console.error('DeepSeek error:', errorText)
      return NextResponse.json(
        {
          reply: 'æˆ‘å¥½åƒæš‚æ—¶è¿ä¸ä¸Šç½‘...è¦ä¸ä½ å…ˆæ·±å‘¼å¸ä¸€ä¸‹ï¼Œæˆ‘ä»¬ç¨åå†è¯•ï¼Ÿ',
          error: errorText,
        },
        { status: response.status },
      )
    }

    const data = await response.json()
    const reply =
      data?.choices?.[0]?.message?.content?.trim() ||
      'æˆ‘åœ¨é™é™åœ°å¬ç€...'

    return NextResponse.json({ reply })
  } catch (error: any) {
    console.error('Chat API error:', error)
    return NextResponse.json(
      {
        reply: 'æœˆäº®æœ‰æ—¶ä¹Ÿä¼šèº²è¿›äº‘é‡Œä¼‘æ¯â€¦æˆ‘ç°åœ¨å°±æ˜¯è¿™æ ·ã€‚ä½†æˆ‘ä¼šä¸€ç›´åœ¨è¿™é‡Œçš„',
        error: error?.message ?? 'Unknown error',
      },
      { status: 500 },
    )
  }
}

